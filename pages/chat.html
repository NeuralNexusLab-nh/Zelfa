<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Zelfa | Chat</title>
    <!-- Marked for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Highlight.js for Code Highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark-reasonable.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        /* Full Screen Hacker UI */
        body { margin: 0; background: #0d0208; color: #00ff41; font-family: 'Courier New', monospace; display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 260px; background: #020a02; border-right: 1px solid #003b00; display: flex; flex-direction: column; transition: 0.3s; }
        .new-chat-btn { margin: 20px; padding: 15px; border-radius: 50px; border: 1px solid #00ff41; background: transparent; color: #00ff41; cursor: pointer; text-align: center; transition: 0.3s; }
        .new-chat-btn:hover { background: #00ff41; color: #000; box-shadow: 0 0 15px #00ff41; }
        
        .hist-list { flex: 1; overflow-y: auto; padding: 10px; }
        .hist-item { padding: 10px; margin-bottom: 5px; border-radius: 5px; cursor: pointer; display: flex; justify-content: space-between; font-size: 0.9rem; border: 1px solid transparent; }
        .hist-item:hover { background: #001a00; border-color: #003300; }
        .hist-item.active { background: #002200; border-color: #00ff41; }
        
        /* Main Chat */
        .main { flex: 1; display: flex; flex-direction: column; position: relative; }
        .top-bar { padding: 15px; border-bottom: 1px solid #003b00; display: flex; justify-content: flex-end; gap: 20px; background: #0d0208; }
        .icon { cursor: pointer; font-size: 1.5rem; opacity: 0.7; transition: 0.2s; }
        .icon:hover { opacity: 1; transform: scale(1.1); text-shadow: 0 0 5px #00ff41; }
        
        .chat-log { flex: 1; overflow-y: auto; padding: 30px; display: flex; flex-direction: column; gap: 20px; }
        .msg { max-width: 85%; padding: 15px; border-radius: 10px; line-height: 1.6; word-wrap: break-word; }
        
        /* User Message: White text, Green background context */
        .msg.user { align-self: flex-end; background: #002200; border: 1px solid #004400; color: #fff; white-space: pre-wrap; font-family: inherit; }
        
        /* AI Message: Black bg, Green text */
        .msg.ai { align-self: flex-start; border-left: 3px solid #00ff41; background: #000; color: #00ff41; }
        .msg.err { color: red; border: 1px solid red; align-self: center; }

        /* Hacker Style Code Blocks */
        .hacker-code-box {
            margin: 15px 0;
            border: 1px solid #00ff41;
            background: #050505;
            position: relative;
        }

        .hacker-code-header {
            background: #003b00;
            border-bottom: 3px solid #00ff41; /* Thick top border for content */
            padding: 5px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 0.85rem;
            color: #fff;
        }

        .hacker-code-header .lbl {
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .hacker-code-header .right-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .hacker-code-header .len {
            color: #88ffaa;
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .copy-btn {
            background: none;
            border: none;
            color: #00ff41;
            cursor: pointer;
            font-size: 1.1rem;
            transition: 0.2s;
            opacity: 0.8;
            padding: 0;
            display: flex;
            align-items: center;
        }

        .copy-btn:hover {
            opacity: 1;
            text-shadow: 0 0 8px #00ff41;
            transform: scale(1.1);
        }

        /* Override highlight.js background to blend with hacker theme */
        .hacker-code-box pre { margin: 0; padding: 10px; overflow-x: auto; }
        .hacker-code-box code { font-family: 'Courier New', monospace; background: transparent !important; padding: 0; }

        /* Highlight Colors */
        .hljs-keyword, .hljs-selector-tag, .hljs-literal, .hljs-section, .hljs-link { color: #ff79c6; }
        .hljs-function .hljs-keyword { color: #ff79c6; }
        .hljs-string, .hljs-title, .hljs-name, .hljs-type, .hljs-attribute, .hljs-symbol, .hljs-bullet, .hljs-addition, .hljs-variable, .hljs-template-tag, .hljs-template-variable { color: #f1fa8c; }
        .hljs-comment, .hljs-quote, .hljs-meta { color: #6272a4; }
        .hljs-keyword, .hljs-strong { font-weight: bold; }

        /* Input Area */
        .input-zone { padding: 20px; background: linear-gradient(to top, #0d0208 90%, transparent); display: flex; justify-content: center; }
        .input-wrap { width: 80%; max-width: 800px; background: #001100; border: 1px solid #00ff41; border-radius: 25px; padding: 10px 20px; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0, 255, 65, 0.1); }
        textarea { background: transparent; border: none; color: #fff; resize: none; outline: none; font-family: inherit; font-size: 1rem; max-height: 200px; }
        
        .controls { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; border-top: 1px solid #003300; padding-top: 10px; }
        select { background: #000; color: #00ff41; border: 1px solid #003b00; padding: 5px; border-radius: 5px; outline: none; }
        .send-circle { width: 40px; height: 40px; border-radius: 50%; background: #00ff41; border: none; cursor: pointer; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 1.2rem; transition: 0.2s; }
        .send-circle:hover { box-shadow: 0 0 15px #00ff41; transform: scale(1.1); }

        /* Modal */
        .modal-ov { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:none; justify-content:center; align-items:center; z-index:100; }
        .modal-in { background: #000; border: 1px solid #00ff41; padding: 20px; width: 300px; text-align: center; }
        .m-btn { margin: 5px; padding: 5px 15px; background: 0; border: 1px solid #00ff41; color: #00ff41; cursor: pointer; }
        .m-btn:hover { background: #00ff41; color: #000; }
    </style>
</head>
<body>

<div class="sidebar">
    <button class="new-chat-btn" onclick="location.href='/chat'">+ CREATE CONVERSATION</button>
    <div class="hist-list" id="histList"></div>
</div>

<div class="main">
    <div class="top-bar">
        <div class="icon" title="Home" onclick="location.href='/'">üè†</div>
        <div class="icon" title="Account" onclick="location.href='/account'">üë§</div>
        <div class="icon" title="Rename" onclick="askRename()">‚úèÔ∏è</div>
        <div class="icon" title="Delete" onclick="askDelete()">üóëÔ∏è</div>
    </div>
    <div class="chat-log" id="chatLog"></div>
    <div class="input-zone">
        <div class="input-wrap">
            <textarea id="txtIn" rows="1" placeholder="Enter command..." oninput="this.style.height='';this.style.height=this.scrollHeight+'px'"></textarea>
            <div class="controls">
                <select id="modelSel">
                    <option value="gpt-oss:120b">GPT oss (Ollama)</option>
                    <option value="qwen3-coder:480b">Qwen3 Coder (Ollama)</option>
                    <option value="deepseek-v3.1:671b">DeepSeek V3 (Ollama)</option>
                    <option value="kimi-k2:1t">Kimi k2 (Ollama)</option>
                    <option value="kimi-k2-thinking">Kimi k2 thinking(Ollama)</option>
                    <option value="glm-4.6">GLM 4.6 (Ollama)</option>
                    <option value="cogito-2.1:671b">Cogito 2.1 (Ollama)</option>
                    <option value="gemini-2.0-flash">Gemini 2.0 Flash (Google AI Studio)</option>
                    <option value="gpt-5-nano">GPT-5 Nano (OpenAI)</option>
                    <option value="o3-mini">GPT-o3 Mini [VIP] (OpenAI)</option>
                    <option value="gpt-5.1-codex-mini">GPT-5.1 Codex Mini [VIP] (OpenAI)</option>
                </select>
                <button class="send-circle" onclick="sendMsg()">‚Üë</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal-ov" id="modal">
    <div class="modal-in">
        <p id="mText"></p>
        <input id="mInput" style="display:none; width:90%; background:#222; border:1px solid #0f0; color:#0f0; margin-bottom:10px;">
        <button class="m-btn" id="mYes">CONFIRM</button>
        <button class="m-btn" onclick="document.getElementById('modal').style.display='none'">CANCEL</button>
    </div>
</div>

<script>
    let chatId = null;
    let historyBuffer = [];

    // --- 1. Custom Marked Renderer (Fixed for Marked v12+) ---
    const renderer = new marked.Renderer();
    renderer.code = function(tokenObj) {
        // [FIX] Handle new Marked API where arguments are an object ({text, lang...})
        // instead of separate arguments (code, lang).
        
        let codeText = "";
        let lang = "";

        if (typeof tokenObj === 'object' && tokenObj !== null && tokenObj.text !== undefined) {
            // New Marked Version
            codeText = tokenObj.text;
            lang = tokenObj.lang || 'plaintext';
        } else {
            // Fallback for older versions or if structure is different
            codeText = String(tokenObj || "");
            lang = (arguments[1]) || 'plaintext';
        }

        const validLang = hljs.getLanguage(lang) ? lang : 'plaintext';
        const highlighted = hljs.highlight(codeText, { language: validLang }).value;
        const len = codeText.length;
        
        return `
        <div class="hacker-code-box">
            <div class="hacker-code-header">
                <span class="lbl">Code</span>
                <div class="right-controls">
                    <span class="len">Length: ${len}</span>
                    <button class="copy-btn" onclick="copyCode(this)" title="Copy Code">‚ùê</button>
                </div>
            </div>
            <pre><code class="hljs ${validLang}">${highlighted}</code></pre>
        </div>
        `;
    };
    marked.setOptions({ renderer: renderer });

    // --- Copy Functionality ---
    function copyCode(btn) {
        const box = btn.closest('.hacker-code-box');
        const codeEl = box.querySelector('code');
        const text = codeEl.textContent;

        navigator.clipboard.writeText(text).then(() => {
            const original = btn.innerHTML;
            btn.innerHTML = '‚úî';
            btn.style.color = '#00ff41';
            btn.style.textShadow = '0 0 10px #00ff41';
            setTimeout(() => {
                btn.innerHTML = '‚ùê';
                btn.style.color = '';
                btn.style.textShadow = '';
            }, 2000);
        }).catch(err => console.error('Copy failed:', err));
    }

    // --- 2. Helper to Escape HTML ---
    function escapeHtml(text) {
        if (!text) return "";
        return String(text)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    async function init() {
        const parts = location.pathname.split('/');
        if(parts[2]) await loadChat(parts[2]);
        loadSidebar();
    }

    async function loadSidebar() {
        try {
            const res = await fetch('/api/chat/load', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({})});
            const data = await res.json();
            const list = document.getElementById('histList');
            list.innerHTML = '';
            if(data.list) {
                data.list.forEach(item => {
                    const div = document.createElement('div');
                    div.className = `hist-item ${item.id === chatId ? 'active' : ''}`;
                    div.innerHTML = `<span>${escapeHtml(item.title)}</span>`;
                    div.onclick = () => location.href = `/chat/${item.id}`;
                    list.appendChild(div);
                });
            }
        } catch(e) { console.error("Sidebar load failed", e); }
    }

    async function loadChat(id) {
        try {
            const res = await fetch('/api/chat/load', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({chatId: id})});
            const data = await res.json();
            if(data.chat) {
                chatId = id;
                historyBuffer = data.chat.messages || [];
                const log = document.getElementById('chatLog');
                log.innerHTML = '';
                historyBuffer.forEach(m => addBubble(m.role, m.content, false));
                log.scrollTop = log.scrollHeight;
            }
        } catch(e) { console.error("Chat load failed", e); }
    }

    // --- 3. Modified Bubble Logic ---
    function addBubble(role, text, animate) {
        const safeText = String(text || "");
        
        const log = document.getElementById('chatLog');
        const div = document.createElement('div');
        div.className = `msg ${role}`;
        
        log.appendChild(div);

        if(role === 'user') {
            div.textContent = safeText;
        } else if(role === 'ai') {
            if(animate) {
                div.innerHTML = "<span style='color:#0f0'>ZELFA></span> _"; 
                let currentText = "";
                let remainingText = safeText;
                
                const typeStep = () => {
                    if(remainingText.length === 0) {
                        div.innerHTML = marked.parse(safeText);
                        log.scrollTop = log.scrollHeight;
                        return;
                    }
                    
                    const chunkSize = Math.floor(Math.random() * (40 - 20 + 1) + 20);
                    const chunk = remainingText.substring(0, chunkSize);
                    remainingText = remainingText.substring(chunkSize);
                    currentText += chunk;

                    // Pass pure string to marked
                    div.innerHTML = marked.parse(currentText) + "<span style='opacity:0.5'>_</span>";
                    log.scrollTop = log.scrollHeight;

                    const delay = Math.floor(Math.random() * (30 - 10 + 1) + 10);
                    setTimeout(typeStep, delay);
                };
                typeStep();
            } else {
                div.innerHTML = marked.parse(safeText);
            }
        } else {
            div.textContent = safeText;
        }
        log.scrollTop = log.scrollHeight;
    }

    async function sendMsg() {
        const txt = document.getElementById('txtIn');
        const val = txt.value.trim();
        if(!val) return;
        
        txt.value = '';
        txt.style.height = 'auto'; 
        
        addBubble('user', val, false);
        historyBuffer.push({role:'user', content:val});

        const loadDiv = document.createElement('div');
        loadDiv.className = 'msg ai';
        loadDiv.textContent = '...GENERATING...';
        document.getElementById('chatLog').appendChild(loadDiv);
        document.getElementById('chatLog').scrollTop = document.getElementById('chatLog').scrollHeight;

        try {
            const res = await fetch('/api/models', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    model: document.getElementById('modelSel').value,
                    prompt: val,
                    chatId: chatId,
                    messages: historyBuffer.slice(-4)
                })
            });
            
            loadDiv.remove();
            
            if(res.status === 429) {
                addBubble('err', 'DAILY QUOTA EXCEEDED', false);
                return;
            }
            
            const data = await res.json();
            if(data.error) throw new Error(data.error);

            if(!chatId && data.chatId) {
                chatId = data.chatId;
                history.pushState({}, '', `/chat/${chatId}`);
                loadSidebar();
            }

            const reply = data.reply || ""; 

            historyBuffer.push({role:'ai', content: reply});
            addBubble('ai', reply, true);

        } catch(e) {
            loadDiv.remove();
            addBubble('err', 'ERROR: ' + e.message, false);
        }
    }

    document.getElementById('txtIn').addEventListener('keydown', e => {
        if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); }
    });

    // Modal Logic
    function showM(txt, useInput, cb) {
        const m = document.getElementById('modal');
        const inp = document.getElementById('mInput');
        document.getElementById('mText').innerText = txt;
        inp.style.display = useInput ? 'block' : 'none';
        inp.value = '';
        m.style.display = 'flex';
        
        const yesBtn = document.getElementById('mYes');
        const newYesBtn = yesBtn.cloneNode(true);
        yesBtn.parentNode.replaceChild(newYesBtn, yesBtn);
        
        newYesBtn.onclick = () => {
            cb(useInput ? inp.value : true);
            m.style.display = 'none';
        };
    }

    function askRename() {
        if(!chatId) return;
        showM("NEW TITLE:", true, async (val) => {
            if(val) {
                await fetch('/api/chat/action', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({action:'rename', chatId, newTitle: val})});
                loadSidebar();
            }
        });
    }

    function askDelete() {
        if(!chatId) return;
        showM("DELETE CHAT PERMANENTLY?", false, async () => {
            await fetch('/api/chat/action', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({action:'delete', chatId})});
            location.href = '/chat';
        });
    }

    init();
</script>
</body>
</html>
